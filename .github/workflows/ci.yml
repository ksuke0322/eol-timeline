name: CI

on:
  push:
    branches:
      - main
    paths: &PATHS
      - 'app/**'
      - '__e2e__'
      - '.storybook'
      - 'public/**'
      - 'test'
      - 'components.json'
      - 'eslint.config.mjs'
      - 'playwright.config.ts'
      - 'react-router.config.ts'
      - 'tsconfig.json'
      - 'vite-plugin-remove-data-testid.ts'
      - 'vite.config.ts'
      - 'wrangler.jsonc'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/ci_base.yml'
      - '.github/workflows/ci.yml'
  workflow_dispatch: # 手動実行も可能

jobs:
  call:
    uses: ./.github/workflows/ci_base.yml
    secrets: inherit

  # https://blog.chick-p.work/blog/github-actions-workflow-deploy-cf-wokers
  deploy:
    runs-on: ubuntu-latest
    needs: status_check_complete
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: true

      - name: Build project
        run: pnpm build

      - name: Mask secrets
        run: echo "::add-mask::${{ secrets.CF_WORKERS_URL }}"

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          # default の 3.90.0 だと wrangler.toml しか受け付けないため明示指定
          wranglerVersion: '4.32.0'
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          apiToken: ${{ secrets.CF_API_TOKEN }}
